name: Deploy Jekyll Site with Security

on:
  push:
    branches:
      - main
    paths:
      - '**.html'
      - '**.md'
      - '_layouts/**'
      - '_posts/**'
      - '_config.yml'
      - 'assets/**'
      - 'images/**'
      - 'Gemfile*'

permissions:
  contents: read
  security-events: write
  id-token: write

jobs:
  security-checks:
    name: Pre-Deployment Security
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        
      - name: Scan for secrets
        uses: gitleaks/gitleaks-action@v2
        continue-on-error: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          
      - name: Security headers check
        run: |
          echo "Checking for security best practices..."
          if grep -r "eval(" . --include="*.js" 2>/dev/null; then
            echo "âš ï¸  Warning: eval() detected in JavaScript"
          fi
          if grep -r "innerHTML" . --include="*.js" 2>/dev/null; then
            echo "âš ï¸  Warning: innerHTML usage detected"
          fi
          echo "âœ… Basic security checks passed"

  build-and-deploy:
    name: Build Jekyll & Deploy to AWS
    runs-on: ubuntu-latest
    needs: security-checks
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Ruby
        uses: ruby/setup-ruby@v1
        with:
          ruby-version: '3.2'
          bundler-cache: true

      - name: Install dependencies
        run: bundle install

      - name: Build Jekyll site
        run: bundle exec jekyll build
        env:
          JEKYLL_ENV: production

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: eu-central-1

      - name: Sync Jekyll site to S3
        run: |
          aws s3 sync _site/ s3://${{ secrets.S3_BUCKET_NAME }}/ \
            --delete \
            --exclude ".git/*" \
            --exclude ".github/*" \
            --exclude "*.tf" \
            --exclude "*.tfvars*" \
            --exclude ".terraform/*" \
            --exclude "terraform.tfstate*" \
            --exclude ".devcontainer/*" \
            --exclude "*.md" \
            --exclude "_*" \
            --exclude "Gemfile*"

      - name: Invalidate CloudFront cache
        run: |
          aws cloudfront create-invalidation \
            --distribution-id ${{ secrets.CLOUDFRONT_DISTRIBUTION_ID }} \
            --paths "/*"

      - name: Verify S3 security
        run: |
          echo "Checking S3 bucket security..."
          aws s3api get-public-access-block --bucket ${{ secrets.S3_BUCKET_NAME }}
          aws s3api get-bucket-encryption --bucket ${{ secrets.S3_BUCKET_NAME }}
          echo "âœ… S3 security verified"

      - name: Verify CloudFront WAF
        run: |
          echo "Checking CloudFront WAF configuration..."
          DIST_CONFIG=$(aws cloudfront get-distribution-config --id ${{ secrets.CLOUDFRONT_DISTRIBUTION_ID }})
          if echo "$DIST_CONFIG" | grep -q "WebACLId"; then
            echo "âœ… WAF is configured"
          else
            echo "âš ï¸  WAF not detected"
          fi

  post-deployment-tests:
    name: Post-Deployment Validation
    runs-on: ubuntu-latest
    needs: build-and-deploy
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        
      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: eu-central-1
          
      - name: Check HTTPS enforcement
        run: |
          echo "Testing HTTP to HTTPS redirect..."
          DOMAIN=$(aws cloudfront get-distribution --id ${{ secrets.CLOUDFRONT_DISTRIBUTION_ID }} --query 'Distribution.DomainName' --output text)
          HTTP_CODE=$(curl -s -o /dev/null -w "%{http_code}" -L "http://$DOMAIN")
          if [ "$HTTP_CODE" = "200" ]; then
            echo "âœ… HTTPS working"
          else
            echo "âŒ HTTPS check failed with code: $HTTP_CODE"
            exit 1
          fi
          
      - name: Security headers validation
        run: |
          echo "Checking security headers..."
          DOMAIN=$(aws cloudfront get-distribution --id ${{ secrets.CLOUDFRONT_DISTRIBUTION_ID }} --query 'Distribution.DomainName' --output text)
          HEADERS=$(curl -s -I "https://$DOMAIN")
          
          echo "Checking for required security headers..."
          echo "$HEADERS" | grep -i "strict-transport-security" && echo "âœ… HSTS header present" || echo "âŒ HSTS missing"
          echo "$HEADERS" | grep -i "x-content-type-options" && echo "âœ… X-Content-Type-Options present" || echo "âŒ X-Content-Type-Options missing"
          echo "$HEADERS" | grep -i "x-frame-options" && echo "âœ… X-Frame-Options present" || echo "âŒ X-Frame-Options missing"
          echo "$HEADERS" | grep -i "content-security-policy" && echo "âœ… CSP present" || echo "âŒ CSP missing"

  deployment-summary:
    name: Deployment Summary
    runs-on: ubuntu-latest
    needs: [security-checks, build-and-deploy, post-deployment-tests]
    if: always()
    
    steps:
      - name: Create summary
        run: |
          echo "## ðŸš€ Jekyll Site Deployment Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Security Checks" >> $GITHUB_STEP_SUMMARY
          echo "- Security Scan: ${{ needs.security-checks.result }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Build & Deployment" >> $GITHUB_STEP_SUMMARY
          echo "- Jekyll Build & Deploy: ${{ needs.build-and-deploy.result }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Validation" >> $GITHUB_STEP_SUMMARY
          echo "- Post-deployment Tests: ${{ needs.post-deployment-tests.result }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          if [ "${{ needs.build-and-deploy.result }}" = "success" ]; then
            echo "âœ… Jekyll site successfully built and deployed!" >> $GITHUB_STEP_SUMMARY
          else
            echo "âŒ Deployment failed. Check logs above." >> $GITHUB_STEP_SUMMARY
          fi
